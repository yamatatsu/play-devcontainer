# npm (Package Manager)

## 選定理由

npmは**安定性と広範なエコシステムサポート**を重視し、消去法的に選定された。

### 主な判断基準

1. **広範な採用実績**
   - 2024年の調査では、開発者の56.6%がnpmを使用（Yarn Classic: 21.5%, pnpm: 19.9%）
   - 最も長い歴史を持ち、ほぼすべてのライブラリ・ツールが対応

2. **DevContainer環境での安定性**
   - pnpmやYarn Berryと異なり、特別な設定なしで動作
   - コンテナ環境での追加の考慮事項が少ない

3. **学習コストの低さ**
   - チームメンバーが既に習熟している
   - ドキュメントやトラブルシューティング情報が豊富

## 代替案との比較

### pnpm

**採用を見送った理由**:

DevContainer環境との相性に懸念があり、実際には遭遇していないが、以下のような問題が報告されている：

1. **ハードリンクの制限**
   - Dockerコンテナとホストファイルシステム間でハードリンクが作成できない
   - pnpmの中核機能（グローバルストアからのリンク）が機能不全に陥る可能性
   - 参考: [pnpm公式ドキュメント](https://pnpm.io/docker)では、同一ファイルシステム内でのみハードリンクが機能すると明記

2. **OS差異による動作不良のリスク**
   - 異なるDebianバージョンのコンテナ間でpnpmストアを共有すると、ビルドされたnpmパッケージのOS差異を検出できず問題が発生する
   - ENOENTエラー（`ENOENT: no such file or directory, copyfile`）の報告が複数存在
   - 参考: [Stack Overflow - pnpm in DevContainer OS versions](https://stackoverflow.com/questions/77965895/)

3. **追加設定の必要性**
   - 回避策として`pnpm config set store-dir ~/.local/share/pnpm/store`等の設定が必要
   - DevContainer環境ではシンプルさが重要であり、追加の複雑性を避けたい

**pnpmの利点（認識しているが採用しなかった）**:
- インストール速度が最速
- ディスク使用量を最大70%削減
- モノレポでのパフォーマンスが優秀

### Yarn

**採用を見送った理由**:

1. **Yarn v1 (Classic)の放棄**
   - v1は完全にメンテナンスモードで新機能が追加されない（フリーズ状態）
   - 公式が「Yarn Modern（Berry）への移行」を推奨
   - 長期的な保守性に懸念

2. **Yarn v2+ (Berry)のPnP問題**
   - Plug'n'Play (PnP)の互換性問題でエコシステムの採用が進まず
   - TypeScript、React Native、Expo等の主要ツールがPnP未対応または部分対応
   - IDE統合に特別な設定が必要
   - 既存プロジェクトの移行に数日かかるケースも
   - 参考: [Hacker News議論](https://news.ycombinator.com/item?id=34974504)では「Yarnは自ら足を撃った」との評価

3. **採用率の低下**
   - 2024年時点でYarn Classicは21.5%のシェア（npm: 56.6%）
   - Yarn Modernへの移行が進んでいない（多くのユーザーがnpmに戻った）

### bun

**採用を見送った理由**:

1. **チームの習熟度不足**
   - 開発者がbunに慣れていない
   - 新しいツールの学習コストを避けたい

2. **評価不足**
   - Turborepoとの互換性、エコシステムの成熟度について十分な検証を実施していない
   - **再選定時には慎重な評価が必要**

## npmの弱点と受け入れ

### パフォーマンス

- **インストール速度**: pnpmやYarnと比較して遅い
- **ディスク使用量**: pnpmと比べて最大70%多い

→ **現時点では許容範囲**。プロジェクト規模拡大時に再評価が必要。

### セキュリティ

- `npm audit`の運用方針は**未策定**
- DevContainerによるホスト保護を優先しており、package manager自体のセキュリティ機能は二次的

### モノレポ対応

- npm workspacesは機能するが、pnpmやYarn Berryと比較して効率性に劣る
- Turborepoとの組み合わせで現時点では問題なし

## 批判的考察

### 消極的な選定

npmの選定は**積極的な理由ではなく、他の選択肢の問題を避けた結果**である：

- pnpm: DevContainer環境での不確実性
- Yarn: エコシステムの分断と保守性の懸念
- bun: 評価不足

この消極的選定は以下のリスクを伴う：

1. **パフォーマンス最適化の機会損失**
   - pnpmやbunの速度・効率性を活用できない
   - プロジェクト規模拡大時にボトルネックになる可能性

2. **技術的負債の蓄積**
   - 将来的にpnpmやbunへ移行する際のコストが増大
   - 依存関係の構造がnpm前提で固定化される

### 再選定の検討が必要なケース

以下の状況では、package managerの再評価が必要：

1. **DevContainer + pnpmの実績が蓄積された場合**
   - コミュニティでの成功事例が増加
   - 公式ドキュメントでベストプラクティスが確立

2. **パフォーマンス問題が顕在化した場合**
   - CI/CDでのインストール時間が許容範囲を超える
   - モノレポの規模拡大でディスク使用量が問題になる

3. **bunのエコシステムが成熟した場合**
   - Turborepo等の主要ツールとの互換性が確認される
   - セキュリティ・保守性の実績が蓄積される

## CLAUDE.mdとの整合性

CLAUDE.mdには「DevContainers typically run one codebase per container, eliminating the need for global package caching that pnpm provides」と記載されているが、これは**pnpmのディスク効率化機能の必要性が低い**という意味であり、相性問題とは別の観点である。

実際の選定理由は：
- pnpmのグローバルキャッシュの利点 < DevContainer環境での動作不確実性のリスク

---

**結論**: npmは**安定性と簡潔性を優先した保守的な選択**である。パフォーマンスよりも、DevContainer環境での確実な動作とチームの習熟度を重視した。将来的な再選定の余地を残しつつ、現時点での最小リスクの選択肢として採用している。
