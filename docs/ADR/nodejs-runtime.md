# Node.js (JavaScript Runtime)

## 選定理由

Node.jsは**エコシステムの成熟度と安定性**を重視し、bunの導入コストが払えないため**消極的に選定**された。

### 主な判断基準

1. **エコシステムの成熟度**
   - ほぼ全てのライブラリ・ツールがNode.js対応
   - トラブルシューティング情報が豊富
   - 企業での採用実績が圧倒的

2. **安定性**
   - 長年の実績により、予期しない問題が少ない
   - 既存スタック（Turborepo、Prisma、Vite等）との互換性が確実

3. **導入コストの低さ**
   - チームメンバーが既に習熟している
   - DevContainer環境のセットアップが容易

## 代替案との比較

### Bun（有力候補）

**採用を見送った理由**:

Bunは**Node.jsの完全置き換え**として有力候補であったが、以下の導入コストが払えず見送った。

#### Bunの期待されたメリット

1. **統一されたツールチェーン**
   - Package Manager（bunのみでnpm不要）
   - 開発用ランタイム
   - 本番環境ランタイム
   - **複数のJavaScriptランタイムが関与することを避けたかった**
   - 開発コンテキストの増大を危惧

2. **Alpine Linuxでの安定動作**
   - **2024年11月、Bun v1.1.35でmusl libcネイティブサポートが実装**
   - 参考: [Bun v1.1.35 Release](https://bun.sh/blog/bun-v1.1.35)
   - それ以前はglibc互換ハックに依存していたが、現在は公式Alpineイメージ（`oven/bun:alpine`）がネイティブサポート
   - Node.jsがalpineで抱える問題（musl/glibc互換性、node-gypビルド問題）を回避可能
   - ただし、**まだエッジケースや一部ツールとの互換性問題が残る**（例: Drizzle Kit、Astro等）

3. **パフォーマンス優位性**
   - 起動速度・実行速度がNode.jsより高速
   - **認識済みだが、現在のNode.jsのパフォーマンスで問題はない**
   - **bunの速度優位性が必要になるユースケースは想定していない**

#### 導入を阻んだ障壁

##### 1. DevContainer環境の整備失敗

- **DevContainer Featuresでの導入を試みたがエラーで失敗**
- 開発環境のセットアップに追加の時間投資が必要
- チーム全体でのセットアップ手順の標準化が困難

##### 2. 既存スタックとの互換性が未検証

以下のツールとの互換性を十分に検証していない：

**Turborepo**:
- ベータサポートあり（2023年9月発表）
- 実用例が複数報告されており、基本的に動作する
- 参考: [Turborepo Bun Beta Support](https://x.com/turborepo/status/1702791416672387094)
- **制限事項**: `turbo prune`の完全サポート等、一部機能が未対応
- 参考: [Support prune in Bun workspaces](https://github.com/vercel/turborepo/discussions/7456)
- **ワークスペース管理**: `--cwd`オプションが必須など、npm/pnpmと異なる挙動

**Prisma**:
- 公式サポートあり、基本的に動作する
- 参考: [Use Prisma with Bun](https://bun.sh/guides/ecosystem/prisma), [How to use Prisma ORM with Bun](https://www.prisma.io/docs/guides/bun)
- **重大な制約**: **PrismaのCLI（`prisma generate`等）を実行するにはNode.jsのインストールが必須**
- つまり、**純粋なBun-onlyの環境は不可能**
- これは「Node.jsを完全に置き換える」という当初の期待に反する
- 2024年を通じて互換性改善が進んでいるが、Node.js依存は解消されていない

**Vite**:
- Bun v0.7以降、公式サポート
- 参考: [Build a frontend using Vite and Bun](https://bun.com/guides/ecosystem/vite)
- 開発サーバー起動、ビルド実行が高速化
- **制限事項**: ViteがBunのバンドラー・モジュールリゾルバーを活用する最適化はまだ進んでいない
- Node.js互換性改善は2024年を通じて継続的に実施

##### 3. 完全置き換えが不可能

- Prismaの制約により、**開発環境にNode.jsとBunの両方が必要**
- 当初の期待「複数のJSランタイムを避ける」が達成できない
- むしろランタイムが増える結果となり、開発コンテキストが増大

#### Bunへの将来的な移行可能性

以下の条件が揃えば、Bunへの移行を検討する：

1. **DevContainer環境の整備が完了**
   - DevContainer Featuresまたは手動セットアップの確立
   - チーム全体での再現可能な環境構築手順

2. **Prismaの完全Bun対応**
   - Node.js不要で`prisma generate`等が実行可能になる
   - または、PrismaからDrizzle等の代替ORMへの移行

3. **Turborepoの完全サポート**
   - `turbo prune`等の未対応機能が解消
   - ベータから正式サポートへ移行

4. **パフォーマンス要件の変化**
   - CI/CDのビルド時間短縮が必要になる
   - アプリケーションの起動速度が重要になる

**移行のリスク**:
- 現時点では低い（エコシステムが急速に成熟中）
- ただし、Bunの開発停滞時にNode.jsに戻るコストは限定的（package.json互換性あり）

### Deno

**採用を見送った理由**:

DenoはNode.jsとの互換性の低さから、**開発停滞時にNode.jsに戻るのが困難**になるため選定しなかった。

#### Node.js互換性の問題点（全て該当）

Deno 2（2024年リリース）で互換性が大幅に改善されたが、依然として以下の制約がある：

##### 1. package.jsonとnode_modulesのサポート制限

- **Deno 2でpackage.json、node_modules、npm workspacesをサポート開始**
- 参考: [Announcing Deno 2](https://deno.com/blog/v2.0), [Why We Added package.json Support](https://deno.com/blog/package-json-support)
- ただし、**Denoネイティブな開発スタイルとは異なる**
- Deno 2.xでは、package.jsonがあっても自動的にnpmパッケージをインストールしない（`deno install`が必要）

##### 2. CommonJSサポートの制限

- **CommonJSはnpm imports経由でのみサポート**
- Denoネイティブコードではサポートされない（ESMのみ）
- レガシーなNode.jsライブラリとの互換性に問題

##### 3. ビルトインモジュールの扱い

- Node.jsのビルトインモジュール（`fs`, `path`等）を参照する際、**bare specifier（`"fs"`）は使えない**
- npm依存関係以外では**`"node:fs"`形式が必須**
- 既存のNode.jsコードを移植する際に書き換えが必要

##### 4. セキュリティ制限

- post-install scriptsを任意に実行しない
- ユーザー空間のセキュリティパーミッションを強制
- これは利点でもあるが、既存のnpmエコシステムとの互換性を損なう場合がある

##### 5. その他の互換性問題

- トランスパイルサーバー（esm.sh、skypack等）の制限
- ランタイムでデータファイルをロードするnpmモジュールが動作しない場合がある

#### Denoの利点（認識しているが採用しなかった）

- **TypeScript・JSXのネイティブサポート**（ビルド不要）
- **標準ライブラリの充実**
- **セキュリティファーストのアーキテクチャ**（パーミッションシステム）
- **Next.js、Astro、Remix等の主要フレームワークをサポート**（Deno 2以降）

#### 後戻りの困難さ

Denoを採用した場合、以下の理由でNode.jsへの移行が困難：

1. **コードベースの書き換えが必要**
   - ビルトインモジュールの`"node:*"`形式を書き戻し
   - Deno標準APIの使用箇所をNode.js APIに置換
   - パーミッションシステム前提のコードを修正

2. **ツールチェーンの変更**
   - Denoの`deno.json`からNode.jsの`package.json`へ移行
   - ビルドプロセスの再構築（TypeScript/JSXのビルドが必要に）

3. **開発停滞時のリスク**
   - Denoのエコシステムがまだ成熟途上
   - メンテナンス不能になった場合、Node.jsへの巻き戻しコストが高い

**Bunとの比較**:
- Bunはpackage.json互換性が高く、Node.jsへの後戻りが容易
- Denoは独自エコシステムであり、移行の不可逆性が高い

## Node.jsの弱点と受け入れ

### パフォーマンス

- Bunと比較して起動速度・実行速度が遅い
- **現時点では問題なし**。将来的に要件が変化すれば再評価が必要

### イメージサイズ

- Bunの方が軽量
- Alpine環境での問題が多く、結局`node:slim`を使用（150-200MB）
- Bunなら`oven/bun:alpine`でさらに小型化可能

### LTS (Long Term Support)

- Node.jsにはLTSが存在するが、**選定時には考慮していない**
- 現在使用中のNode.js 24は2024年10月にLTSに移行済み

## 批判的考察

### 消極的選定のリスク

Node.jsの選定は**Bunの導入コストを避けた結果**であり、積極的な理由ではない。この消極的選定は以下のリスクを伴う：

1. **最適化の機会損失**
   - Bunのパフォーマンス優位性を活用できない
   - Alpine環境でのイメージサイズ削減ができない
   - 将来的にパフォーマンスがボトルネックになる可能性

2. **技術的負債の蓄積**
   - Bunへの移行タイミングを逃すと、コードベースが大きくなり移行コストが増大
   - Node.js前提の設計が固定化される

3. **エコシステムの変化への対応遅れ**
   - 2024年のBunの急速な成熟（musl対応、各種ツールサポート）に追従していない
   - 業界トレンドから取り残されるリスク

### Prisma依存の問題

Bunへの移行を阻む最大の要因は**PrismaのNode.js依存**である。以下の選択肢が考えられる：

1. **Prismaを受け入れ、Node.js + Bunの併用を許容**
   - 「完全置き換え」を諦め、開発コンテキストの増大を受け入れる
   - 本番環境はBun、CLIツールのみNode.jsという分離

2. **代替ORMへの移行（Drizzle等）**
   - Bunネイティブ対応のORMに移行
   - ただし、移行コストとPrismaの優位性を天秤にかける必要

3. **Prismaの完全Bun対応を待つ**
   - 現状維持で、Prismaの改善を待つ
   - ただし、対応時期は不明

### DevContainer Featuresエラーの未解決

「DevContainer Featuresでエラーが出た」という理由で導入を諦めたのは、**十分な調査不足**の可能性がある：

- 手動インストールスクリプトでの回避は試したか？
- エラーの根本原因を特定したか？
- コミュニティでの解決事例を調査したか？

## 再選定の検討が必要なケース

以下の状況では、Bunへの移行を真剣に検討すべき：

1. **パフォーマンス要件の顕在化**
   - CI/CDのビルド時間が許容範囲を超える
   - アプリケーション起動速度が問題になる

2. **Alpine環境への移行需要**
   - Dockerイメージサイズの削減が重要になる
   - Bunの`oven/bun:alpine`ネイティブサポートを活用

3. **Prismaの代替採用**
   - Drizzle等のBunネイティブORMへの移行
   - または、Prismaの完全Bun対応が実現

4. **DevContainer環境の整備完了**
   - Bunのセットアップ手順が確立
   - チーム全体での導入が可能になる

5. **業界トレンドの変化**
   - Bunの採用事例が増加し、デファクトスタンダードになる
   - 主要ライブラリ・フレームワークのBun最適化が進む

## Denoの再評価が必要なケース

Denoは現時点では選択肢から外れているが、以下の場合は再評価が必要：

1. **セキュリティ要件の厳格化**
   - パーミッションシステムが必須になる場合

2. **TypeScript/JSXネイティブ実行の価値が高まる**
   - ビルドプロセスの排除がチーム生産性に寄与する場合

3. **Deno 2のエコシステム成熟**
   - npm互換性がさらに改善され、後戻りが容易になる場合

---

**結論**: Node.jsは**安定性と成熟度を優先した保守的な選択**であるが、Bunの導入コストを避けた**消極的選定**である。将来的にはBunへの移行が有力な選択肢として残されており、DevContainer環境の整備とPrisma問題の解決が移行の鍵となる。Denoは互換性の制約と後戻りの困難さから、現時点では選択肢から除外している。
